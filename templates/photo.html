{% extends "base.html" %}
{% block title %}{{ photo['caption'] or 'Photo' }}{% endblock %}

{% block content %}
<div class="photo-detail">
  <div class="photo-detail-img-wrap">
    {% if images|length > 1 %}
      <div class="carousel">
        <div class="carousel-track" data-current="0">
          {% for img in images %}
            <div class="carousel-slide">
              {% if img['media_type'] == 'video' %}
                <video controls playsinline>
                  <source src="{{ img['cloudinary_url'] }}">
                </video>
              {% else %}
                <img src="{{ img['cloudinary_url'] }}" alt="{{ photo['caption'] or 'Photo' }}">
              {% endif %}
            </div>
          {% endfor %}
        </div>
        <button class="carousel-btn carousel-prev" onclick="moveCarousel(this, -1)" aria-label="Previous">&#8249;</button>
        <button class="carousel-btn carousel-next" onclick="moveCarousel(this, 1)" aria-label="Next">&#8250;</button>
        <div class="carousel-dots">
          {% for img in images %}
            <button class="carousel-dot {% if loop.first %}active{% endif %}" onclick="goToSlide(this, {{ loop.index0 }})"></button>
          {% endfor %}
        </div>
      </div>
    {% else %}
      {% if images[0]['media_type'] == 'video' %}
        <video controls playsinline>
          <source src="{{ images[0]['cloudinary_url'] }}">
        </video>
      {% else %}
        <img src="{{ images[0]['cloudinary_url'] }}" alt="{{ photo['caption'] or 'Photo' }}">
      {% endif %}
    {% endif %}
  </div>

  <div class="photo-detail-meta">
    {% if photo['caption'] %}
      <p class="photo-caption">{{ photo['caption'] }}</p>
    {% endif %}
    <p class="photo-date">{{ photo['created_at'][:10] }}</p>

    {% if session.get('logged_in') %}
      <form
        class="delete-form"
        method="post"
        action="{{ url_for('delete_photo', photo_id=photo['id']) }}"
        onsubmit="return confirm('Delete this photo and all its comments?')"
      >
        <button class="btn btn-danger" type="submit">Delete photo</button>
      </form>
    {% endif %}
  </div>
</div>

<section class="comments-section">
  <h2>Comments <span class="comment-count">({{ comments|length }})</span></h2>

  {% if comments %}
    <ul class="comment-list">
      {% for c in comments %}
        <li class="comment">
          <p class="comment-author">{{ c['name'] }}</p>
          <p class="comment-body">{{ c['body'] }}</p>
          <p class="comment-date">{{ c['created_at'][:16].replace('T', ' ') }}</p>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p class="empty-state">No comments yet. Be the first!</p>
  {% endif %}

  <div class="comment-form-wrap">
    <h3>Leave a comment</h3>
    <form class="comment-form" method="post" action="{{ url_for('add_comment', photo_id=photo['id']) }}">
      <label for="name">Name</label>
      <input
        id="name"
        name="name"
        type="text"
        placeholder="Your name"
        maxlength="80"
        required
      >

      <label for="body">Comment</label>
      <textarea
        id="body"
        name="body"
        rows="4"
        placeholder="Write somethingâ€¦"
        maxlength="2000"
        required
      ></textarea>

      <button class="btn btn-primary" type="submit">Post comment</button>
    </form>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
function getCarousel(el) {
  return el.closest('.carousel');
}
function moveCarousel(btn, direction) {
  const carousel = getCarousel(btn);
  const track = carousel.querySelector('.carousel-track');
  const count = track.querySelectorAll('.carousel-slide').length;
  let current = parseInt(track.dataset.current);
  current = (current + direction + count) % count;
  applySlide(carousel, track, current);
}
function goToSlide(dot, index) {
  const carousel = getCarousel(dot);
  const track = carousel.querySelector('.carousel-track');
  applySlide(carousel, track, index);
}
function applySlide(carousel, track, index) {
  track.dataset.current = index;
  track.style.transform = 'translateX(-' + (index * 100) + '%)';
  carousel.querySelectorAll('.carousel-dot').forEach(function(d, i) {
    d.classList.toggle('active', i === index);
  });
}
</script>
{% endblock %}
